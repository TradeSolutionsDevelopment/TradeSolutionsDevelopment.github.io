<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, shrink-to-fit=no">
    <title>8-bit COMMANDO ¬∑ HUGE PLAYER ¬∑ ANALOG STICK ¬∑ NO FULLSCREEN</title>
    <meta name="description" content="GameBoy style. Double‚Äësize soldier, virtual joystick, 6 enemies, 5 power‚Äëups. Pixel perfect.">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        html, body {
            width: 100%;
            height: 100%;
            background: #0a1a1f;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Courier New', Courier, monospace;
            touch-action: pan-y;
        }
        .arcade-cabinet {
            background: #1c3840;
            padding: 15px 15px 20px;
            border-radius: 30px 30px 15px 15px;
            box-shadow: 0 15px 0 #0c1c22, 0 20px 30px rgba(0,0,0,0.8);
            border-bottom: 8px solid #2d5662;
            max-width: 1000px;
            width: 100%;
            height: auto;
            margin: auto;
            display: flex;
            flex-direction: column;
        }
        canvas {
            display: block;
            margin: 0 auto;
            border: 6px solid #2e5665;
            border-radius: 16px;
            box-shadow: inset 0 0 0 4px #6d9eb0, 0 8px 0 #142f39;
            width: 100%;
            height: auto;
            aspect-ratio: 800 / 500;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
            background: #10262e;
        }
        .panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            color: #b9f3ff;
            text-shadow: 2px 2px 0 #0f2a30;
            background: #1f424b;
            padding: 8px 16px;
            border-radius: 40px;
            border-bottom: 6px solid #0e262c;
            font-size: clamp(14px, 4vw, 20px);
            font-weight: 900;
            letter-spacing: 2px;
            flex-wrap: wrap;
        }
        .scores {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .scores span {
            background: #10262e;
            padding: 4px 12px;
            border-radius: 30px;
            border-bottom: 4px solid #308595;
            color: #fdffb8;
            margin-left: 6px;
            font-size: clamp(14px, 4vw, 20px);
        }
        .btn {
            background: #cf4e5c;
            color: white;
            border: none;
            border-radius: 40px;
            padding: 8px 18px;
            font-size: clamp(16px, 4vw, 22px);
            font-weight: bold;
            border-bottom: 6px solid #822c36;
            cursor: pointer;
            transition: 0.06s;
            font-family: 'Courier New', monospace;
            text-shadow: 2px 2px 0 #4e1e24;
            letter-spacing: 2px;
        }
        .btn:active {
            background: #ec6a7a;
            border-bottom-width: 3px;
            transform: translateY(3px);
        }
        .legend {
            color: #b3ecff;
            font-size: 15px;
            display: flex;
            gap: 20px;
            background: #16353f;
            padding: 8px 16px;
            border-radius: 40px;
            border-bottom: 5px solid #0b1f24;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 10px;
        }
        .health {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .health span { font-size: 24px; }

        /* ----------  TOUCH CONTROLS ‚Äì ANALOG STICK (LEFT) + AB (CENTERED) ‚Äì NO FULLSCREEN ---------- */
        .touch-controls {
            display: none;
            margin-top: 15px;
            justify-content: space-between;
            align-items: center;
            gap: 5px;
            padding: 10px 5px;
            background: #2b4b55;
            border-radius: 60px;
            border-bottom: 8px solid #16333a;
            touch-action: none;
        }
        /* virtual analog stick container ‚Äì clean, no arrows */
        .joystick {
            width: 140px;
            height: 140px;
            background: #1f3a40;
            border-radius: 50%;
            border-bottom: 8px solid #0f262c;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            touch-action: none;
        }
        .joystick-base {
            width: 100px;
            height: 100px;
            background: #2f4f58;
            border-radius: 50%;
            border-bottom: 6px solid #1a2f35;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        .joystick-handle {
            width: 60px;
            height: 60px;
            background: #5f838c;
            border-radius: 50%;
            border-bottom: 6px solid #3a555e;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0;          /* remove any text */
            color: transparent;
            box-shadow: inset 0 -2px 0 #3a555e;
            transition: 0.02s;
            position: relative;
            left: 0;
            top: 0;
            touch-action: none;
        }
        .joystick-handle:active {
            border-bottom-width: 2px;
            transform: translateY(4px);
        }
        /* AB buttons ‚Äì centered */
        .ab-buttons {
            display: flex;
            gap: 15px;
            margin-left: 0;       /* natural centering */
            margin-right: auto;
            padding-left: 10px;
        }
        .ab {
            background: #9e4a5c;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border-bottom: 8px solid #632c38;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            color: white;
            text-shadow: 3px 3px 0 #3a1e24;
            box-shadow: inset 0 -4px 0 #753a46;
            cursor: pointer;
            touch-action: none;
        }
        .ab:active {
            border-bottom-width: 3px;
            transform: translateY(5px);
            background: #c05e72;
        }
        /* fullscreen toggle ‚Äì HIDDEN ON MOBILE (removed) */
        .fullscreen-toggle {
            display: none;   /* completely removed ‚Äì no fullscreen button */
        }

        /* Show touch controls only on narrow screens ‚Äì no fullscreen, clean joystick */
        @media (max-width: 900px) {
            .touch-controls {
                display: flex !important;
            }
            .legend {
                display: none;
            }
            .joystick {
                width: 120px;
                height: 120px;
            }
            .joystick-base {
                width: 90px;
                height: 90px;
            }
            .joystick-handle {
                width: 55px;
                height: 55px;
            }
            .ab {
                width: 70px;
                height: 70px;
                font-size: 26px;
            }
        }

        /* Fullscreen ‚Äì still usable if requested via browser, but no button */
        .arcade-cabinet:fullscreen {
            max-width: 100%;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: #0f1e24;
            border-radius: 0;
            padding: 10px;
        }
        .arcade-cabinet:fullscreen canvas {
            max-height: 60vh;
            width: auto;
            max-width: 95%;
        }
    </style>
</head>
<body>
<div class="arcade-cabinet" id="gameCabinet">
    <canvas id="gameCanvas" width="800" height="500"></canvas>
    
    <div class="panel">
        <div class="scores">üéØ <span id="scoreDisplay">00000</span></div>
        <div class="scores">üèÜ <span id="highScoreDisplay">00000</span></div>
        <button class="btn" id="restartButton">‚Üª RESTART</button>
    </div>
    
    <!-- Desktop legend (hidden on mobile) -->
    <div class="legend">
        <span><i>‚Üê ‚Üí</i> MOVE</span>
        <span><i>‚Üë / SPACE</i> DOUBLE JUMP</span>
        <span><i>Z</i> FIRE  &nbsp; <i>X</i> BOMB</span>
        <div class="health">‚ù§Ô∏è <span id="healthDisplay">‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</span></div>
        <span id="levelDisplay">LVL 1</span>
    </div>

    <!-- ========== TOUCH CONTROLS ‚Äì CLEAN ANALOG STICK + AB BUTTONS ========== -->
    <div class="touch-controls" id="touchControls">
        <!-- Left: virtual analog stick ‚Äì no arrows, just a smooth puck -->
        <div class="joystick" id="joystickContainer">
            <div class="joystick-base" id="joystickBase">
                <div class="joystick-handle" id="joystickHandle"></div> <!-- no text -->
            </div>
        </div>
        <!-- AB buttons ‚Äì centered -->
        <div class="ab-buttons">
            <div class="ab" id="touchFire">FIRE</div>
            <div class="ab" id="touchBomb">BOMB</div>
        </div>
        <!-- NO FULLSCREEN BUTTON ‚Äì removed -->
    </div>
</div>

<script>
    (function(){
        'use strict';
        const canvas = document.getElementById('gameCanvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        if (!ctx) return;
        ctx.imageSmoothingEnabled = false;

        // ----------  WORLD & CAMERA ----------
        const WORLD_WIDTH = 3200;
        const VIEWPORT_W = 800, VIEWPORT_H = 500;
        const GROUND_Y = 460;
        let cameraX = 0;

        // ----------  GLOBAL STATE ----------
        let gameActive = true;
        let gameOver = false;
        let victoryFlag = false;
        let currentLevel = 1;
        const MAX_LEVEL = 3;
        let frame = 0;
        let animFrameId = null;

        // ----------  SCORE & HIGHSCORE ----------
        let score = 0;
        let highScore = 0;
        try { highScore = localStorage.getItem('commandoElite') ? parseInt(localStorage.getItem('commandoElite')) : 0; } catch(e) { highScore = 0; }
        let playerHealth = 6;
        const MAX_HEALTH = 6;

        // ----------  POWER-UPS ----------
        let rapidFire = false, rapidTimer = 0;
        let shieldActive = false, shieldTimer = 0;
        let spreadShot = false, spreadTimer = 0;
        let invincibleStar = false, starTimer = 0;

        // ----------  PLAYER PHYSICS ‚Äì DOUBLE SIZE ----------
        const PLAYER_WIDTH = 44;
        const PLAYER_HEIGHT = 56;
        const GRAVITY = 0.7;
        const JUMP_FORCE = -13.5;
        const MOVE_SPEED = 4.8;

        let player = {
            x: 220, y: GROUND_Y - PLAYER_HEIGHT,
            vx: 0, vy: 0,
            onGround: false,
            doubleJumpUsed: false,
            coyoteTime: 0,
            jumpBuffer: 0,
            facing: 1,
            walkCycle: 0,
            shootTimer: 0,
            invincible: 0,
            bombCooldown: 0,
        };

        // ----------  LEVEL DESIGN ----------
        let platforms = [];
        let enemySpawners = [];
        let exitDoor = null;
        let levelName = "";

        // ----------  DYNAMIC ENTITIES ----------
        let bullets = [];
        let enemies = [];
        let enemyBullets = [];
        let explosions = [];
        let pickups = [];
        let dustEffects = [];
        let sparks = [];
        let screenShake = 0;

        // ----------  KEYBOARD STATE ----------
        const keys = { left: false, right: false, jump: false, fire: false, bomb: false, down: false, up: false };

        // ----------  LEVEL DEFINITIONS ‚Äì platforms lowered ----------
        function buildLevel(level) {
            platforms = []; enemySpawners = []; exitDoor = null;
            if (level === 1) {
                levelName = "FORGOTTEN JUNGLE";
                platforms = [
                    { x: 400, y: 390, w: 120, h: 14 }, { x: 650, y: 330, w: 100, h: 14 },
                    { x: 920, y: 370, w: 110, h: 14 }, { x: 1200, y: 310, w: 120, h: 14 },
                    { x: 1500, y: 350, w: 110, h: 14 }, { x: 1820, y: 290, w: 130, h: 14 },
                    { x: 2180, y: 400, w: 100, h: 14 }, { x: 2500, y: 330, w: 140, h: 14 }
                ];
                enemySpawners = [
                    { x: 550, type: 'infantry', side: 'right', behavior: 'flank' },
                    { x: 950, type: 'drone', side: 'left', behavior: 'swoop' },
                    { x: 1350, type: 'sniper', side: 'right', behavior: 'aim' },
                    { x: 1850, type: 'heavy', side: 'right', behavior: 'block' },
                    { x: 2300, type: 'jumper', side: 'left', behavior: 'leap' }
                ];
                exitDoor = { x: 2800, y: GROUND_Y - 60 };
            } else if (level === 2) {
                levelName = "MACHINE COMPLEX";
                platforms = [
                    { x: 380, y: 330, w: 120, h: 14 }, { x: 620, y: 270, w: 100, h: 14 },
                    { x: 860, y: 390, w: 110, h: 14 }, { x: 1120, y: 230, w: 120, h: 14 },
                    { x: 1400, y: 350, w: 110, h: 14 }, { x: 1720, y: 290, w: 130, h: 14 },
                    { x: 2080, y: 400, w: 100, h: 14 }, { x: 2400, y: 250, w: 140, h: 14 }
                ];
                enemySpawners = [
                    { x: 520, type: 'heavy', side: 'right', behavior: 'block' },
                    { x: 780, type: 'sniper', side: 'left', behavior: 'aim' },
                    { x: 1150, type: 'drone', side: 'right', behavior: 'swoop' },
                    { x: 1550, type: 'jumper', side: 'left', behavior: 'leap' },
                    { x: 1950, type: 'infantry', side: 'right', behavior: 'flank' },
                    { x: 2450, type: 'boss_lieutenant', side: 'right', behavior: 'command' }
                ];
                exitDoor = { x: 2900, y: GROUND_Y - 60 };
            } else if (level === 3) {
                levelName = "HELL HANGAR";
                platforms = [
                    { x: 440, y: 370, w: 140, h: 14 }, { x: 720, y: 290, w: 120, h: 14 },
                    { x: 1000, y: 230, w: 120, h: 14 }, { x: 1300, y: 350, w: 110, h: 14 },
                    { x: 1640, y: 290, w: 130, h: 14 }, { x: 2000, y: 400, w: 100, h: 14 },
                    { x: 2350, y: 250, w: 140, h: 14 }
                ];
                enemySpawners = [
                    { x: 580, type: 'heavy', side: 'right', behavior: 'block' },
                    { x: 840, type: 'sniper', side: 'left', behavior: 'aim' },
                    { x: 1150, type: 'drone', side: 'right', behavior: 'swoop' },
                    { x: 1500, type: 'jumper', side: 'left', behavior: 'leap' },
                    { x: 1880, type: 'infantry', side: 'right', behavior: 'flank' },
                    { x: 2300, type: 'boss', side: 'right', behavior: 'final' }
                ];
                exitDoor = { x: 2800, y: GROUND_Y - 60 };
            }
        }

        // ----------  RESET GAME ----------
        function resetGame() {
            gameActive = true; gameOver = false; victoryFlag = false; currentLevel = 1;
            score = 0; playerHealth = MAX_HEALTH;
            rapidFire = false; rapidTimer = 0; shieldActive = false; shieldTimer = 0;
            spreadShot = false; spreadTimer = 0; invincibleStar = false; starTimer = 0;
            player = {
                x: 220, y: GROUND_Y - PLAYER_HEIGHT, vx: 0, vy: 0, onGround: false,
                doubleJumpUsed: false, coyoteTime: 0, jumpBuffer: 0, facing: 1,
                walkCycle: 0, shootTimer: 0, invincible: 0, bombCooldown: 0
            };
            bullets = []; enemies = []; enemyBullets = []; explosions = []; pickups = [];
            dustEffects = []; sparks = []; screenShake = 0;
            buildLevel(currentLevel); cameraX = 0;
            keys.left = false; keys.right = false; keys.jump = false; keys.fire = false; keys.bomb = false; keys.down = false; keys.up = false;
            updateUI();
        }

        // ----------  UI ----------
        function updateUI() {
            try {
                let scr = String(Math.floor(score)).padStart(5, '0');
                document.getElementById('scoreDisplay').innerText = scr;
                let hscr = String(highScore).padStart(5, '0');
                document.getElementById('highScoreDisplay').innerText = hscr;
                let healthBar = '';
                for (let i=0; i<playerHealth; i++) healthBar += '‚ñà';
                document.getElementById('healthDisplay').innerText = healthBar.padEnd(6, '‚ñë');
                document.getElementById('levelDisplay').innerText = levelName;
            } catch(e) {}
        }

        // ----------  COLLISION ----------
        function collides(r1, r2) {
            return r1.x < r2.x + r2.w && r1.x + r1.w > r2.x && r1.y < r2.y + r2.h && r1.y + r1.h > r2.y;
        }

        function addShake(amount) { screenShake = Math.min(screenShake + amount, 12); }
        function updateCamera() {
            let targetX = player.x + PLAYER_WIDTH/2 - VIEWPORT_W/2;
            targetX = Math.max(0, Math.min(targetX, WORLD_WIDTH - VIEWPORT_W));
            cameraX += (targetX - cameraX) * 0.12;
            if (screenShake > 0) screenShake *= 0.8; else screenShake = 0;
        }
        function addDust(x, y) { dustEffects.push({ x, y, life: 12 }); }
        function addSparks(x, y) { sparks.push({ x, y, life: 10 }); }

        // ----------  PLAYER UPDATE ‚Äì analog movement ----------
        function updatePlayer() {
            if (!gameActive) return;
            if (playerHealth <= 0) { gameActive = false; gameOver = true; victoryFlag = false; return; }

            if (rapidTimer > 0) rapidTimer--; else rapidFire = false;
            if (shieldTimer > 0) shieldTimer--; else shieldActive = false;
            if (spreadTimer > 0) spreadTimer--; else spreadShot = false;
            if (starTimer > 0) starTimer--; else invincibleStar = false;

            // analog movement
            let accelX = 0;
            if (keys.left) accelX -= 1;
            if (keys.right) accelX += 1;
            player.vx = accelX * MOVE_SPEED;
            player.x += player.vx;
            if (player.x < 20) player.x = 20;
            if (player.x + PLAYER_WIDTH > WORLD_WIDTH - 20) player.x = WORLD_WIDTH - PLAYER_WIDTH - 20;

            // coyote time
            if (player.onGround) { player.coyoteTime = 8; player.doubleJumpUsed = false; }
            else player.coyoteTime--;
            if (player.jumpBuffer > 0) player.jumpBuffer--;

            // jump logic ‚Äì triggered by joystick up or keyboard
            let canJump = (player.onGround || player.coyoteTime > 0) && !player.doubleJumpUsed;
            let canDoubleJump = !player.onGround && !player.doubleJumpUsed && player.coyoteTime <= 0;
            if (player.jumpBuffer > 0) {
                if (canJump) {
                    player.vy = JUMP_FORCE;
                    player.onGround = false;
                    player.coyoteTime = 0;
                    player.jumpBuffer = 0;
                    addDust(player.x + PLAYER_WIDTH/2, player.y + PLAYER_HEIGHT);
                } else if (canDoubleJump) {
                    player.vy = JUMP_FORCE * 0.9;
                    player.doubleJumpUsed = true;
                    player.jumpBuffer = 0;
                    addDust(player.x + PLAYER_WIDTH/2, player.y + PLAYER_HEIGHT);
                }
            }

            // gravity
            player.vy += GRAVITY;
            player.y += player.vy;

            // ground collision
            player.onGround = false;
            if (player.y + PLAYER_HEIGHT > GROUND_Y) {
                player.y = GROUND_Y - PLAYER_HEIGHT;
                player.vy = 0;
                player.onGround = true;
                player.doubleJumpUsed = false;
                addDust(player.x + PLAYER_WIDTH/2, player.y + PLAYER_HEIGHT);
            }

            // platform collisions
            for (let pl of platforms) {
                if (player.vy >= 0) {
                    let bottom = player.y + PLAYER_HEIGHT;
                    let prevBottom = bottom - player.vy;
                    if (prevBottom <= pl.y && bottom >= pl.y &&
                        player.x + PLAYER_WIDTH > pl.x && player.x < pl.x + pl.w) {
                        player.y = pl.y - PLAYER_HEIGHT;
                        player.vy = 0;
                        player.onGround = true;
                        player.doubleJumpUsed = false;
                        addDust(player.x + PLAYER_WIDTH/2, player.y + PLAYER_HEIGHT);
                    }
                }
            }
            if (player.y < 30) player.y = 30;

            // facing direction
            if (player.vx > 0.2) player.facing = 1;
            else if (player.vx < -0.2) player.facing = -1;

            // walk cycle
            if (Math.abs(player.vx) > 0.5 && player.onGround) {
                player.walkCycle = (player.walkCycle + 0.2) % 4;
            } else player.walkCycle = 0;

            // shooting
            if (keys.fire && gameActive) {
                let fireRate = rapidFire ? 5 : 14;
                if (player.shootTimer <= 0) {
                    if (spreadShot) {
                        bullets.push({ x: player.facing === 1 ? player.x + PLAYER_WIDTH - 4 : player.x - 20, y: player.y + PLAYER_HEIGHT/2 - 8, w: 20, h: 8, vx: player.facing * 11, vy: -3 });
                        bullets.push({ x: player.facing === 1 ? player.x + PLAYER_WIDTH - 4 : player.x - 20, y: player.y + PLAYER_HEIGHT/2 - 4, w: 20, h: 8, vx: player.facing * 12, vy: 0 });
                        bullets.push({ x: player.facing === 1 ? player.x + PLAYER_WIDTH - 4 : player.x - 20, y: player.y + PLAYER_HEIGHT/2, w: 20, h: 8, vx: player.facing * 11, vy: 3 });
                    } else {
                        bullets.push({ x: player.facing === 1 ? player.x + PLAYER_WIDTH - 4 : player.x - 20, y: player.y + PLAYER_HEIGHT/2 - 4, w: 22, h: 8, vx: player.facing * 12, vy: 0 });
                    }
                    player.shootTimer = fireRate;
                }
            }
            if (player.shootTimer > 0) player.shootTimer--;

            // bomb
            if (keys.bomb && player.bombCooldown <= 0 && gameActive) {
                addShake(8);
                for (let i = enemies.length - 1; i >= 0; i--) {
                    let e = enemies[i];
                    if (Math.abs(e.x - player.x) < 500) {
                        explosions.push({ x: e.x + e.w/2, y: e.y + e.h/2, life: 24, radius: 20 });
                        score += e.points;
                        addSparks(e.x + e.w/2, e.y + e.h/2);
                        enemies.splice(i, 1);
                    }
                }
                player.bombCooldown = 300;
            }
            if (player.bombCooldown > 0) player.bombCooldown--;
            if (player.invincible > 0) player.invincible--;
            if (invincibleStar) player.invincible = Math.max(player.invincible, 2);
        }

        // ----------  ENEMY SPAWN ‚Äì slightly larger for visibility ----------
        function checkSpawners() {
            for (let i = enemySpawners.length - 1; i >= 0; i--) {
                let s = enemySpawners[i];
                if (player.x > s.x - 300 && player.x < s.x + 100) {
                    let side = s.side;
                    let xPos = side === 'right' ? WORLD_WIDTH - 80 : 80;
                    let yPos = GROUND_Y - 40;
                    let enemy = null;
                    switch (s.type) {
                        case 'infantry':
                            enemy = {
                                x: xPos, y: GROUND_Y - 40, w: 30, h: 36,
                                vx: side === 'right' ? -2.2 : 2.2, health: 2, points: 40,
                                type: 'infantry', behavior: s.behavior, frame: 0,
                                shootTimer: 40 + Math.random() * 20
                            }; break;
                        case 'heavy':
                            enemy = {
                                x: xPos, y: GROUND_Y - 44, w: 38, h: 42,
                                vx: side === 'right' ? -1.2 : 1.2, health: 6, points: 120,
                                type: 'heavy', behavior: s.behavior, frame: 0, shootTimer: 30
                            }; break;
                        case 'drone':
                            yPos = 220 + Math.random() * 180;
                            enemy = {
                                x: xPos, y: yPos, w: 28, h: 24,
                                vx: side === 'right' ? -3.0 : 3.0, health: 1, points: 50,
                                type: 'drone', behavior: s.behavior, frame: 0, shootTimer: 50
                            }; break;
                        case 'sniper':
                            enemy = {
                                x: xPos, y: GROUND_Y - 44, w: 28, h: 36,
                                vx: side === 'right' ? -0.9 : 0.9, health: 3, points: 90,
                                type: 'sniper', behavior: s.behavior, frame: 0, shootTimer: 80
                            }; break;
                        case 'jumper':
                            enemy = {
                                x: xPos, y: GROUND_Y - 40, w: 28, h: 34,
                                vx: side === 'right' ? -2.4 : 2.4, health: 2, points: 80,
                                type: 'jumper', behavior: s.behavior, frame: 0, shootTimer: 60, jumpTimer: 20
                            }; break;
                        case 'boss_lieutenant':
                            enemy = {
                                x: WORLD_WIDTH - 120, y: GROUND_Y - 60, w: 56, h: 56,
                                vx: -0.9, health: 20, points: 400, type: 'boss_lieutenant',
                                behavior: s.behavior, frame: 0, shootTimer: 25, phase: 1
                            }; break;
                        case 'boss':
                            enemy = {
                                x: WORLD_WIDTH - 140, y: GROUND_Y - 70, w: 70, h: 70,
                                vx: -0.7, health: 45, points: 1000, type: 'boss',
                                behavior: s.behavior, frame: 0, shootTimer: 18, phase: 1
                            }; break;
                    }
                    if (enemy) enemies.push(enemy);
                    enemySpawners.splice(i, 1);
                }
            }
        }

        // ----------  ENEMY UPDATE ‚Äì with AI ----------
        function updateEnemies() {
            for (let i = enemies.length - 1; i >= 0; i--) {
                let e = enemies[i];
                e.x += e.vx;
                e.frame = (e.frame + 0.15) % 4;
                if (e.x + e.w < -150 || e.x > WORLD_WIDTH + 150) { enemies.splice(i, 1); continue; }

                if (e.type === 'drone' && e.behavior === 'swoop') e.y += Math.sin(frame * 0.1) * 0.7;
                if (e.type === 'jumper' && e.behavior === 'leap') {
                    e.jumpTimer--;
                    if (e.jumpTimer <= 0 && Math.abs(e.x - player.x) < 250 && e.y + e.h >= GROUND_Y - 5) {
                        e.vy = JUMP_FORCE * 0.8;
                        e.jumpTimer = 50 + Math.random() * 40;
                    }
                    e.y += e.vy || 0;
                    e.vy = (e.vy || 0) + GRAVITY * 0.5;
                    if (e.y + e.h > GROUND_Y) { e.y = GROUND_Y - e.h; e.vy = 0; }
                }
                if (e.type === 'sniper' && e.behavior === 'aim') { e.vx = 0; e.shootTimer = 40; }
                if (e.type === 'infantry' && e.behavior === 'flank') {
                    if (player.x > e.x) e.vx = 1.4; else e.vx = -1.4;
                }

                e.shootTimer--;
                if (e.shootTimer <= 0 && gameActive && playerHealth > 0 && Math.abs(e.x - player.x) < 650) {
                    let bulletVX = e.x > player.x ? -6 : 6;
                    if (e.type === 'drone') bulletVX *= 1.3;
                    if (e.type === 'sniper') bulletVX *= 1.6;
                    enemyBullets.push({
                        x: e.x + (bulletVX > 0 ? e.w : -10), y: e.y + e.h/2 - 4,
                        w: 12, h: 6, vx: bulletVX, vy: 0
                    });
                    e.shootTimer = e.type === 'heavy' ? 55 : (e.type === 'sniper' ? 70 : (e.type === 'boss' || e.type === 'boss_lieutenant' ? 22 : 45));
                }

                let inv = player.invincible > 0 || invincibleStar;
                if (!inv && gameActive && playerHealth > 0 && !shieldActive) {
                    if (collides({ x: player.x, y: player.y, w: PLAYER_WIDTH, h: PLAYER_HEIGHT },
                                 { x: e.x, y: e.y, w: e.w, h: e.h })) {
                        let dmg = (e.type === 'heavy' || e.type === 'boss' || e.type === 'boss_lieutenant') ? 2 : 1;
                        playerHealth -= dmg;
                        player.invincible = 70;
                        addShake(5);
                        if (playerHealth < 0) playerHealth = 0;
                        updateUI();
                    }
                }
            }
        }

        // ----------  BULLETS ----------
        function updateBullets() {
            for (let i = bullets.length - 1; i >= 0; i--) {
                let b = bullets[i];
                b.x += b.vx;
                b.y += b.vy || 0;
                if (b.x > WORLD_WIDTH + 150 || b.x < -150) { bullets.splice(i, 1); continue; }
                for (let j = enemies.length - 1; j >= 0; j--) {
                    let e = enemies[j];
                    if (collides({ x: b.x, y: b.y, w: b.w, h: b.h },
                                 { x: e.x, y: e.y, w: e.w, h: e.h })) {
                        bullets.splice(i, 1);
                        e.health -= 1;
                        addSparks(e.x + e.w/2, e.y + e.h/2);
                        if (e.health <= 0) {
                            score += e.points;
                            if (score > highScore) { highScore = score; try { localStorage.setItem('commandoElite', highScore); } catch(e) {} }
                            explosions.push({ x: e.x + e.w/2, y: e.y + e.h/2, life: 22, radius: 18 });
                            addShake(4);
                            if (Math.random() < 0.35) {
                                let types = ['health', 'rapid', 'shield', 'spread', 'star'];
                                let type = types[Math.floor(Math.random() * types.length)];
                                pickups.push({ x: e.x, y: e.y, w: 20, h: 20, type: type, vx: -1, life: 500 });
                            }
                            enemies.splice(j, 1);
                        }
                        break;
                    }
                }
            }
        }

        function updateEnemyBullets() {
            for (let i = enemyBullets.length - 1; i >= 0; i--) {
                let eb = enemyBullets[i];
                eb.x += eb.vx;
                if (eb.x < -150 || eb.x > WORLD_WIDTH + 150) { enemyBullets.splice(i, 1); continue; }
                let inv = player.invincible > 0 || invincibleStar;
                if (!inv && gameActive && playerHealth > 0 && !shieldActive) {
                    if (collides({ x: player.x, y: player.y, w: PLAYER_WIDTH, h: PLAYER_HEIGHT },
                                 { x: eb.x, y: eb.y, w: eb.w, h: eb.h })) {
                        playerHealth -= 1;
                        player.invincible = 50;
                        addShake(3);
                        enemyBullets.splice(i, 1);
                        if (playerHealth < 0) playerHealth = 0;
                        updateUI();
                    }
                }
            }
        }

        // ----------  PICKUPS ----------
        function updatePickups() {
            for (let i = pickups.length - 1; i >= 0; i--) {
                let p = pickups[i];
                p.x += p.vx;
                p.life--;
                if (p.life <= 0 || p.x < -100) { pickups.splice(i, 1); continue; }
                if (collides({ x: player.x, y: player.y, w: PLAYER_WIDTH, h: PLAYER_HEIGHT },
                             { x: p.x, y: p.y, w: p.w, h: p.h })) {
                    if (p.type === 'health') playerHealth = Math.min(MAX_HEALTH, playerHealth + 2);
                    else if (p.type === 'rapid') { rapidFire = true; rapidTimer = 600; }
                    else if (p.type === 'shield') { shieldActive = true; shieldTimer = 600; }
                    else if (p.type === 'spread') { spreadShot = true; spreadTimer = 600; }
                    else if (p.type === 'star') { invincibleStar = true; starTimer = 500; }
                    pickups.splice(i, 1);
                    updateUI();
                }
            }
        }

        // ----------  EFFECTS ----------
        function updateDust() {
            for (let i = dustEffects.length - 1; i >= 0; i--) {
                dustEffects[i].life -= 1.2;
                if (dustEffects[i].life <= 0) dustEffects.splice(i, 1);
            }
        }
        function updateSparks() {
            for (let i = sparks.length - 1; i >= 0; i--) {
                sparks[i].life -= 1.5;
                if (sparks[i].life <= 0) sparks.splice(i, 1);
            }
        }
        function updateExplosions() {
            for (let i = explosions.length - 1; i >= 0; i--) {
                let ex = explosions[i];
                ex.life -= 1.5;
                ex.radius += 1.4;
                if (ex.life <= 0) explosions.splice(i, 1);
            }
        }

        // ----------  EXIT ‚Äì safe when no enemies ----------
        function checkExit() {
            if (exitDoor && player.x > exitDoor.x - 40 && enemies.length === 0) {
                if (currentLevel < MAX_LEVEL) {
                    currentLevel++;
                    buildLevel(currentLevel);
                    player.x = 220; player.y = GROUND_Y - PLAYER_HEIGHT; cameraX = 0;
                    rapidFire = false; rapidTimer = 0; shieldActive = false; shieldTimer = 0;
                    spreadShot = false; spreadTimer = 0; invincibleStar = false; starTimer = 0;
                    enemies = []; enemyBullets = []; pickups = [];
                    updateUI();
                } else {
                    gameActive = false; gameOver = false; victoryFlag = true;
                }
            }
        }

        // ----------  RENDERING ‚Äì HUGE PLAYER, ENHANCED GRAPHICS ----------
        function drawWorld() {
            if (!ctx) return;
            ctx.save();
            if (screenShake > 0.5) {
                ctx.translate((Math.random()*2-1)*screenShake, (Math.random()*2-1)*screenShake);
            }
            ctx.clearRect(0, 0, VIEWPORT_W, VIEWPORT_H);
            
            // Parallax sky with stars
            let bgOffset = cameraX * 0.2;
            ctx.fillStyle = '#0f2a33'; ctx.fillRect(0, 0, VIEWPORT_W, 130);
            ctx.fillStyle = '#1a414a'; ctx.fillRect(0, 130, VIEWPORT_W, 70);
            ctx.fillStyle = '#25555f'; ctx.fillRect(0, 200, VIEWPORT_W, 60);
            // stars
            ctx.fillStyle = '#cde3e6';
            for (let i=0;i<20;i++) {
                let x = (i*90 + frame*0.2) % 800;
                let y = (i*23) % 120;
                ctx.fillRect(x, y, 2, 2);
            }
            // waterfall
            ctx.fillStyle = '#48a5b0';
            for (let i=0;i<8;i++) {
                let x = (i*150 - bgOffset) % 1000 - 100;
                ctx.fillRect(x, 200, 4, 70);
            }
            // hills
            ctx.fillStyle = '#2a6b4a';
            for (let i=0;i<5;i++) {
                let x = (i*250 - bgOffset*0.5) % 900 - 100;
                ctx.beginPath();
                ctx.moveTo(x, 320);
                ctx.quadraticCurveTo(x+100, 230, x+200, 320);
                ctx.fill();
            }
            // ground with texture
            ctx.fillStyle = '#4b6a3b'; ctx.fillRect(0, GROUND_Y-6, VIEWPORT_W, 20);
            ctx.fillStyle = '#6d8f4d'; ctx.fillRect(0, GROUND_Y-2, VIEWPORT_W, 8);
            for (let i=0;i<30;i++) {
                ctx.fillStyle = '#3b552a';
                ctx.fillRect(i*30 + (cameraX*0.1)%30, GROUND_Y-10, 8, 6);
            }
            
            // platforms ‚Äì wooden with grain
            platforms.forEach(p => {
                let sx = p.x - cameraX;
                if (sx + p.w > 0 && sx < VIEWPORT_W) {
                    ctx.fillStyle = '#5c4934'; ctx.fillRect(sx, p.y, p.w, p.h);
                    ctx.fillStyle = '#846b4a'; ctx.fillRect(sx+2, p.y-3, p.w-4, 5);
                    for (let i=0;i<4;i++) {
                        ctx.fillStyle = '#3d2e1e';
                        ctx.fillRect(sx+10+i*20, p.y+2, 6, 4);
                    }
                }
            });

            // exit door ‚Äì glows when safe
            if (exitDoor) {
                let sx = exitDoor.x - cameraX;
                ctx.fillStyle = enemies.length === 0 ? '#f7d44a' : '#ac8c5a';
                if (enemies.length === 0) { ctx.shadowBlur = 12; ctx.shadowColor = '#ffd966'; }
                ctx.fillRect(sx, exitDoor.y, 36, 60);
                ctx.fillStyle = '#c9ae74'; ctx.fillRect(sx+10, exitDoor.y-10, 16, 14);
                ctx.shadowBlur = 0;
            }

            // enemies ‚Äì detailed
            enemies.forEach(e => {
                let sx = e.x - cameraX;
                if (sx + e.w > 0 && sx < VIEWPORT_W) {
                    if (e.type === 'infantry') {
                        ctx.fillStyle = '#9d4e3a'; ctx.fillRect(sx, e.y, e.w, e.h);
                        ctx.fillStyle = '#000'; ctx.fillRect(sx+4, e.y+6, 5, 5); ctx.fillRect(sx+e.w-9, e.y+6, 5, 5);
                        ctx.fillStyle = '#cec13b'; ctx.fillRect(sx+8, e.y-4, 12, 8);
                    } else if (e.type === 'heavy') {
                        ctx.fillStyle = '#6a4e4e'; ctx.fillRect(sx, e.y, e.w, e.h);
                        ctx.fillStyle = '#3f2f2f'; ctx.fillRect(sx+4, e.y+4, e.w-8, 10);
                        ctx.fillStyle = '#c0a050'; ctx.fillRect(sx+10, e.y-6, 16, 10);
                    } else if (e.type === 'drone') {
                        ctx.fillStyle = '#467c7c'; ctx.fillRect(sx, e.y, e.w, e.h);
                        ctx.fillStyle = '#2d4f4f'; ctx.fillRect(sx+4, e.y+6, 6, 6);
                        ctx.fillStyle = '#a0d0d0'; ctx.fillRect(sx+10, e.y-5, 8, 8);
                    } else if (e.type === 'sniper') {
                        ctx.fillStyle = '#7a5c3c'; ctx.fillRect(sx, e.y, e.w, e.h);
                        ctx.fillStyle = '#000'; ctx.fillRect(sx+6, e.y+4, 4, 6);
                        ctx.fillStyle = '#b38b5b'; ctx.fillRect(sx+e.w-8, e.y-2, 8, 6);
                    } else if (e.type === 'jumper') {
                        ctx.fillStyle = '#b3763a'; ctx.fillRect(sx, e.y, e.w, e.h);
                        ctx.fillStyle = '#8a5a2e'; ctx.fillRect(sx+4, e.y-4, e.w-8, 6);
                    } else if (e.type.includes('boss')) {
                        ctx.fillStyle = '#b34b4b'; ctx.fillRect(sx, e.y, e.w, e.h);
                        ctx.fillStyle = '#d48c48'; ctx.fillRect(sx+10, e.y-10, 20, 14);
                        ctx.fillStyle = '#ffd966'; ctx.fillRect(sx+20, e.y-16, 12, 8);
                    }
                }
            });

            // bullets
            bullets.forEach(b => { let sx = b.x - cameraX; ctx.fillStyle = '#ffe066'; ctx.fillRect(sx, b.y, b.w, b.h); });
            enemyBullets.forEach(b => { let sx = b.x - cameraX; ctx.fillStyle = '#ff8c8c'; ctx.fillRect(sx, b.y, b.w, b.h); });

            // pickups ‚Äì larger icons
            pickups.forEach(p => {
                let sx = p.x - cameraX;
                ctx.fillStyle = '#4caf7a'; ctx.fillRect(sx, p.y, p.w, p.h);
                ctx.fillStyle = 'white'; ctx.font = '20px monospace';
                if (p.type === 'health') ctx.fillText('‚ù§Ô∏è', sx, p.y+16);
                else if (p.type === 'rapid') ctx.fillText('‚ö°', sx, p.y+16);
                else if (p.type === 'shield') ctx.fillText('üõ°Ô∏è', sx, p.y+16);
                else if (p.type === 'spread') ctx.fillText('üåü', sx, p.y+16);
                else if (p.type === 'star') ctx.fillText('‚ú®', sx, p.y+16);
            });

            // explosions
            explosions.forEach(ex => {
                let sx = ex.x - cameraX;
                ctx.fillStyle = `rgba(255, 140, 30, ${ex.life/30})`;
                ctx.beginPath(); ctx.arc(sx, ex.y, ex.radius, 0, 2*Math.PI);
                ctx.fill();
            });

            // dust & sparks
            dustEffects.forEach(d => { let sx = d.x - cameraX; ctx.fillStyle = `rgba(220,200,120,${d.life/15})`; ctx.fillRect(sx-3, d.y-3, 8, 6); });
            sparks.forEach(s => { let sx = s.x - cameraX; ctx.fillStyle = '#ffaa66'; ctx.fillRect(sx, s.y, 4, 4); });

            // ----- DOUBLE SIZE PLAYER with DETAIL -----
            if (player.invincible % 8 < 4 || player.invincible === 0 || invincibleStar) {
                let px = player.x - cameraX, py = player.y;
                // body
                ctx.fillStyle = shieldActive ? '#7fb3d5' : (invincibleStar ? '#ffd966' : '#3a7251');
                ctx.fillRect(px+4, py+4, 36, 44);
                // helmet
                ctx.fillStyle = '#5a8f4c'; ctx.fillRect(px+10, py-4, 24, 14);
                ctx.fillStyle = '#ab8b3b'; ctx.fillRect(player.facing===1 ? px+28 : px, py, 12, 8);
                // gun
                ctx.fillStyle = '#414141';
                if (player.facing === 1) ctx.fillRect(px+36, py+18, 18, 6);
                else ctx.fillRect(px-12, py+18, 18, 6);
                // legs with animation
                ctx.fillStyle = '#2b543a';
                ctx.fillRect(px+6, py+46, 10, 10);
                ctx.fillRect(px+26, py+46, 10, 10);
                // backpack
                ctx.fillStyle = '#4d3e2e';
                ctx.fillRect(px+30, py+12, 8, 14);
                // double jump indicator (wings)
                if (!player.onGround && !player.doubleJumpUsed) {
                    ctx.fillStyle = '#ffe082';
                    ctx.fillRect(px-4, py, 6, 10);
                    ctx.fillRect(px+PLAYER_WIDTH-2, py, 6, 10);
                }
            }

            // level title
            if (frame % 120 < 60 && gameActive) {
                ctx.font = 'bold 24px "Courier New", monospace';
                ctx.fillStyle = '#ffe082';
                ctx.shadowBlur = 8; ctx.shadowColor = 'black';
                ctx.fillText(levelName, 40, 90);
                ctx.shadowBlur = 0;
            }
            ctx.restore();
        }

        // ----------  GAME LOOP ----------
        function gameLoop() {
            if (gameActive) {
                updateCamera();
                checkSpawners();
                updatePlayer();
                updateBullets();
                updateEnemies();
                updateEnemyBullets();
                updatePickups();
                updateExplosions();
                updateDust();
                updateSparks();
                checkExit();
                if (playerHealth <= 0) { gameActive = false; gameOver = true; victoryFlag = false; }
                updateUI();
            }
            drawWorld();
            if (!gameActive) {
                ctx.fillStyle = '#000000bb';
                ctx.fillRect(220, 190, 360, 90);
                ctx.fillStyle = '#ffe98c';
                ctx.font = '36px "Courier New", monospace';
                ctx.textAlign = 'center';
                if (victoryFlag) ctx.fillText('üèÅ VICTORY!', 400, 245);
                else if (gameOver) ctx.fillText('‚ùå GAME OVER', 400, 245);
                else ctx.fillText('- PAUSE -', 400, 245);
            }
            frame++;
            animFrameId = requestAnimationFrame(gameLoop);
        }

        // ----------  ANALOG STICK ‚Äì 8‚ÄëWAY MOVEMENT, CLEAN ----------
        function initAnalogStick() {
            const stick = document.getElementById('joystickHandle');
            const base = document.getElementById('joystickBase');
            const container = document.getElementById('joystickContainer');
            if (!stick || !base || !container) return;

            let active = false;
            const maxDist = 40;

            function handleStart(e) {
                e.preventDefault();
                active = true;
            }

            function handleMove(e) {
                if (!active) return;
                e.preventDefault();
                let touch = e.touches ? e.touches[0] : e;
                let rect = base.getBoundingClientRect();
                let centerX = rect.left + rect.width/2;
                let centerY = rect.top + rect.height/2;
                let dx = touch.clientX - centerX;
                let dy = touch.clientY - centerY;
                let distance = Math.sqrt(dx*dx + dy*dy);
                if (distance > maxDist) {
                    dx = (dx / distance) * maxDist;
                    dy = (dy / distance) * maxDist;
                }
                stick.style.left = dx + 'px';
                stick.style.top = dy + 'px';

                // set direction keys
                keys.left = dx < -10;
                keys.right = dx > 10;
                if (dy < -10) {
                    player.jumpBuffer = 10; // up triggers jump
                    keys.up = true;
                } else {
                    keys.up = false;
                }
                keys.down = dy > 10;
            }

            function handleEnd(e) {
                e.preventDefault();
                active = false;
                stick.style.left = '0px';
                stick.style.top = '0px';
                keys.left = false; keys.right = false; keys.up = false; keys.down = false;
            }

            container.addEventListener('touchstart', handleStart, { passive: false });
            container.addEventListener('touchmove', handleMove, { passive: false });
            container.addEventListener('touchend', handleEnd, { passive: false });
            container.addEventListener('touchcancel', handleEnd, { passive: false });
            container.addEventListener('mousedown', handleStart);
            window.addEventListener('mousemove', handleMove);
            window.addEventListener('mouseup', handleEnd);
        }

        // ----------  TOUCH BUTTONS ‚Äì FIRE & BOMB ----------
        function initTouchButtons() {
            const touchFire = document.getElementById('touchFire');
            const touchBomb = document.getElementById('touchBomb');
            function setKey(key, state, e) {
                if (e) { e.preventDefault(); e.stopPropagation(); }
                keys[key] = state;
            }
            if (touchFire) {
                touchFire.addEventListener('touchstart', (e) => setKey('fire', true, e), { passive: false });
                touchFire.addEventListener('touchend', (e) => setKey('fire', false, e), { passive: false });
                touchFire.addEventListener('mousedown', (e) => setKey('fire', true, e));
                touchFire.addEventListener('mouseup', (e) => setKey('fire', false, e));
            }
            if (touchBomb) {
                touchBomb.addEventListener('touchstart', (e) => setKey('bomb', true, e), { passive: false });
                touchBomb.addEventListener('touchend', (e) => setKey('bomb', false, e), { passive: false });
                touchBomb.addEventListener('mousedown', (e) => setKey('bomb', true, e));
                touchBomb.addEventListener('mouseup', (e) => setKey('bomb', false, e));
            }
        }

        // ----------  KEYBOARD ----------
        function initKeyboard() {
            window.addEventListener('keydown', (e) => {
                if (!gameActive) return;
                switch(e.key) {
                    case 'ArrowLeft': keys.left = true; e.preventDefault(); break;
                    case 'ArrowRight': keys.right = true; e.preventDefault(); break;
                    case 'ArrowUp': case ' ': keys.jump = true; player.jumpBuffer = 10; e.preventDefault(); break;
                    case 'z': case 'Z': keys.fire = true; e.preventDefault(); break;
                    case 'x': case 'X': keys.bomb = true; e.preventDefault(); break;
                }
            });
            window.addEventListener('keyup', (e) => {
                switch(e.key) {
                    case 'ArrowLeft': keys.left = false; e.preventDefault(); break;
                    case 'ArrowRight': keys.right = false; e.preventDefault(); break;
                    case 'ArrowUp': case ' ': keys.jump = false; e.preventDefault(); break;
                    case 'z': case 'Z': keys.fire = false; e.preventDefault(); break;
                    case 'x': case 'X': keys.bomb = false; e.preventDefault(); break;
                }
            });
        }

        // ----------  INIT ----------
        function init() {
            resetGame();
            initAnalogStick();
            initTouchButtons();
            initKeyboard();
            const restartBtn = document.getElementById('restartButton');
            if (restartBtn) {
                restartBtn.addEventListener('click', resetGame);
                restartBtn.addEventListener('touchstart', (e) => { e.preventDefault(); resetGame(); }, { passive: false });
            }
            drawWorld();
            if (animFrameId) cancelAnimationFrame(animFrameId);
            animFrameId = requestAnimationFrame(gameLoop);
        }

        window.addEventListener('load', init);
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            setTimeout(init, 1);
        } else {
            window.addEventListener('DOMContentLoaded', init);
        }
        window.addEventListener('beforeunload', () => cancelAnimationFrame(animFrameId));
    })();
</script>
</body>
</html>
